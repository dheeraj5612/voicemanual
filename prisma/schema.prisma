generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum KnowledgePackageStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum DocumentType {
  MANUAL
  TROUBLESHOOTING_KB
  WARRANTY
  SERVICE_BULLETIN
}

enum ChunkContentType {
  PROCEDURE
  WARNING
  SPECS
  TROUBLESHOOTING
  GENERAL
}

enum SessionSource {
  QR
  DIRECT
}

enum SessionStatus {
  ACTIVE
  RESOLVED
  ESCALATED
  ABANDONED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum CaseStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SafetySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SafetyAction {
  WARNED
  ESCALATED
  BLOCKED
}

// ─── Models ─────────────────────────────────────────────────────────────────

/// A manufacturer or company that owns product lines
model Brand {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  logoUrl         String?
  defaultLanguage String   @default("en")
  voiceConfig     Json?    // VoiceConfig: tone, language, personality, greetingTemplate
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  productLines ProductLine[]
  agents       Agent[]
}

/// A family of products under a brand (e.g. "Dyson V15 Series")
model ProductLine {
  id          String   @id @default(cuid())
  brandId     String
  name        String
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  skus  SKU[]

  @@index([brandId])
}

/// A specific stock-keeping unit — one product, one region, one language
model SKU {
  id              String   @id @default(cuid())
  productLineId   String
  sku             String   @unique
  region          String   @default("US")
  language        String   @default("en")
  firmwareVersion String?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  productLine       ProductLine        @relation(fields: [productLineId], references: [id], onDelete: Cascade)
  knowledgePackages KnowledgePackage[]
  qrCodes           QRCode[]
  sessions          Session[]
  cases             Case[]

  @@index([productLineId])
}

/// A versioned bundle of documents for a SKU (draft → active → archived)
model KnowledgePackage {
  id          String                 @id @default(cuid())
  skuId       String
  version     Int
  status      KnowledgePackageStatus @default(DRAFT)
  createdAt   DateTime               @default(now())
  publishedAt DateTime?

  sku       SKU        @relation(fields: [skuId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([skuId, version])
  @@index([skuId])
}

/// An uploaded manual, troubleshooting KB, warranty doc, or service bulletin
model Document {
  id                 String       @id @default(cuid())
  knowledgePackageId String
  type               DocumentType
  title              String
  sourceUrl          String?
  rawContent         String       // full extracted text
  parsedAt           DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  knowledgePackage KnowledgePackage @relation(fields: [knowledgePackageId], references: [id], onDelete: Cascade)
  chunks           Chunk[]

  @@index([knowledgePackageId])
}

/// Chunked and embedded content for RAG retrieval
model Chunk {
  id          String           @id @default(cuid())
  documentId  String
  content     String
  embedding   String           // serialized vector
  pageStart   Int
  pageEnd     Int
  sectionPath String           // "H1/H2/H3" breadcrumb
  contentType ChunkContentType
  tokenCount  Int
  chunkIndex  Int
  createdAt   DateTime         @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

/// Generated QR code that deep-links a customer into a session
model QRCode {
  id         String   @id @default(cuid())
  skuId      String
  shortCode  String   @unique
  parameters Json     // QRParameters: brandId, productId, sku, region, language, firmware
  scanCount  Int      @default(0)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())

  sku      SKU       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@index([skuId])
  @@index([shortCode])
}

/// A customer support conversation session
model Session {
  id                      String        @id @default(cuid())
  skuId                   String
  knowledgePackageVersion Int           // snapshot of active KP version at session start
  language                String
  source                  SessionSource @default(QR)
  qrCodeId                String?
  status                  SessionStatus @default(ACTIVE)
  resolvedAt              DateTime?
  createdAt               DateTime      @default(now())

  sku             SKU              @relation(fields: [skuId], references: [id], onDelete: Cascade)
  qrCode          QRCode?          @relation(fields: [qrCodeId], references: [id])
  messages        Message[]
  case            Case?
  analyticsEvents AnalyticsEvent[]
  safetyTriggers  SafetyTrigger[]

  @@index([skuId])
  @@index([qrCodeId])
  @@index([status])
}

/// Individual message in a session conversation
model Message {
  id                 String      @id @default(cuid())
  sessionId          String
  role               MessageRole
  content            String
  structuredResponse Json?       // StructuredResponse: citation-rich response schema
  audioUrl           String?
  createdAt          DateTime    @default(now())

  session        Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  safetyTriggers SafetyTrigger[]

  @@index([sessionId])
}

/// Escalation ticket created when AI cannot resolve the issue
model Case {
  id             String     @id @default(cuid())
  sessionId      String     @unique
  skuId          String
  category       String?
  email          String?
  description    String?
  photoUrls      Json?      // string[]
  status         CaseStatus @default(OPEN)
  assignedTo     String?
  transcript     String     // full conversation text
  stepsAttempted Json?      // string[]
  sourcesUsed    Json?      // Citation[]
  webhookSent    Boolean    @default(false)
  createdAt      DateTime   @default(now())
  resolvedAt     DateTime?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sku     SKU     @relation(fields: [skuId], references: [id], onDelete: Cascade)

  @@index([skuId])
  @@index([status])
}

/// Human support agent belonging to a brand
model Agent {
  id        String   @id @default(cuid())
  brandId   String
  name      String
  email     String   @unique
  available Boolean  @default(true)
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
}

/// Analytics event for dashboards and reporting
model AnalyticsEvent {
  id        String   @id @default(cuid())
  sessionId String
  eventType String   // qr_scan, session_start, question, answer, solved, escalated, etc.
  payload   Json
  createdAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([eventType])
}

/// Safety trigger fired when a message touches dangerous topics
model SafetyTrigger {
  id          String         @id @default(cuid())
  messageId   String
  sessionId   String
  triggerType String         // electrical, gas_fire, medical, child_safety, warranty_void, sharp_tools
  severity    SafetySeverity
  action      SafetyAction
  createdAt   DateTime       @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([sessionId])
}
