# VoiceManual — Claude Code Rules

## Code Style

- Use TypeScript strict mode. No `any` types — use `unknown` with type guards if needed.
- Use named exports, not default exports, for library modules (`src/lib/`). Page components use default exports per Next.js convention.
- Validate all API request bodies with Zod schemas at the top of route handlers.
- Use `@/` path alias for all imports (maps to `src/`).
- Tailwind classes only — no CSS modules, styled-components, or inline style objects.
- Prefer server components. Only add `"use client"` when the component needs hooks, event handlers, or browser APIs.

## File Organization

- API routes go in `src/app/api/<resource>/route.ts` using Next.js Route Handlers.
- Business logic goes in `src/lib/`. API routes should be thin — validate input, call lib functions, return response.
- Shared TypeScript types go in `src/types/index.ts`.
- React components go in `src/components/` with PascalCase filenames.
- One component per file. Co-locate component-specific types in the same file.

## Database

- Always run `npx prisma generate` after modifying `prisma/schema.prisma`.
- Use `db.$transaction()` for operations that create/update multiple records atomically.
- Use `findUniqueOrThrow` / `findFirstOrThrow` when the record must exist — let Prisma throw rather than manual null checks.
- Access the Prisma client via `import { db } from "@/lib/db"` — never instantiate a new PrismaClient directly.
- All IDs use `cuid()`. Do not use UUIDs or auto-increment integers.

## AI Integration

- The Claude model is `claude-sonnet-4-20250514`. Do not change the model without discussion.
- Keep `max_tokens` low (300) for voice responses — they are spoken aloud and should be concise.
- The system prompt is built in `src/lib/ai.ts:buildSystemPrompt()`. All prompt engineering changes go there.
- Escalation is detected by parsing `[ESCALATE: reason]` from the AI response. Do not change this protocol without updating both `ai.ts` and `escalation.ts`.
- Never pass user input directly into system prompts. Product names and manual content are trusted (uploaded by manufacturer), but user chat messages go only in the `messages` array.

## Voice / TTS

- ElevenLabs is the primary TTS provider. Browser SpeechSynthesis is the zero-config fallback.
- Voice settings (stability, similarity_boost, style) are in `src/lib/voice.ts`. Adjust per manufacturer needs.
- TTS responses return raw `audio/mpeg` ArrayBuffers, not base64.

## QR Codes

- Short codes are 8-character alphanumeric strings generated by the custom `nanoid` in `utils.ts`.
- QR codes encode a URL in the format: `{APP_URL}/voice?code={shortCode}`.
- Generate both PNG (data URL) and SVG formats.

## Error Handling

- API routes: catch Zod validation errors (return 400) separately from unexpected errors (return 500).
- Log unexpected errors with `console.error` and include the operation context.
- Never expose internal error details or stack traces to the client.
- Client components: use try/catch in async handlers and show user-friendly error messages.

## Security

- Never commit `.env` files. Use `.env.example` as a template.
- Never expose API keys to the client. All AI and TTS calls happen server-side in API routes.
- Validate and sanitize all user input via Zod before processing.
- Rate limiting is not yet implemented — add it before production deployment.

## Testing (to be set up)

- Test files go next to the source file: `foo.ts` → `foo.test.ts`.
- Focus tests on `src/lib/` business logic, especially `manual-parser.ts` and `escalation.ts`.
- Mock the Prisma client and Anthropic SDK in tests.
